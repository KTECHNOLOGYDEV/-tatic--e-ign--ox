<!DOCTYPE html>
<html lang="pt-BR" class="scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>EmpreendaCheck - Consulta de CNPJ</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/heroicons@1.0.1/dist/outline.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(to bottom, #f0f9ff, #e0f2fe);
    }
    .br-flag-gradient {
      background: linear-gradient(135deg, #009C3B 0%, #FFDF00 100%);
    }
    .section-divider {
      @apply border-t border-gray-200 my-6;
    }
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 50;
      color: white;
      font-size: 1.2rem;
    }
    .loading-overlay.hidden {
      display: none;
    }
    .data-card {
      @apply bg-white p-5 rounded-xl shadow-md border border-gray-100 transition-all duration-300 hover:shadow-lg;
    }
    .data-item {
      @apply p-3 bg-gray-50 rounded-lg border border-gray-200 transition-opacity duration-200;
    }
    .fade-in {
      animation: fadeIn 0.5s ease-out forwards;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body class="bg-gray-100 text-gray-800">
  <!-- Overlay de Loading -->
  <div id="loadingOverlay" class="loading-overlay hidden">
    <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-white mb-4"></div>
    <p>Consultando dados...</p>
  </div>

  <header class="br-flag-gradient text-white shadow-lg">
    <div class="container mx-auto px-4 py-6 flex flex-col items-center">
      <h1 class="text-3xl md:text-4xl font-bold">EmpreendaCheck</h1>
      <p class="mt-2 text-center text-lg">Consulta de CNPJ em tempo real</p>
    </div>
  </header>

  <main class="container mx-auto px-4 py-8">
    <div class="max-w-4xl mx-auto">
      <div class="bg-white rounded-xl shadow-lg p-6 mb-6 transition-all duration-300 hover:shadow-xl">
        <div class="mb-6">
          <label for="cnpjInput" class="block text-lg font-medium text-gray-700">Digite o CNPJ</label>
          <div class="flex mt-2">
            <input
              type="text"
              id="cnpjInput"
              placeholder="00.000.000/0000-00"
              class="w-full px-4 py-3 border border-gray-300 rounded-l-lg focus:ring-2 focus:ring-blue-500 focus:outline-none transition"
            />
            <button
              id="searchBtn"
              class="bg-blue-600 hover:bg-blue-700 text-white px-6 rounded-r-lg font-semibold transition flex items-center justify-center"
            >
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
              </svg>
              Buscar
            </button>
          </div>
        </div>

        <div id="loading" class="hidden flex justify-center py-6">
          <div class="animate-spin rounded-full h-10 w-10 border-t-2 border-b-2 border-blue-500"></div>
        </div>

        <div id="error" class="mt-6 hidden text-red-500 bg-red-50 p-4 rounded-lg">
          <p id="errorMsg"></p>
        </div>
      </div>

      <div id="result" class="mt-6 hidden">
        <!-- Botão para exportar PDF -->
        <div class="mb-6 text-right">
          <button id="exportPdfBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-semibold transition flex items-center justify-center mx-auto md:mx-0">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
            </svg>
            Exportar PDF
          </button>
        </div>

        <!-- Dados Principais -->
        <div class="data-card fade-in mb-6">
          <h2 class="text-xl font-bold mb-4 text-gray-800">Dados da Empresa</h2>
          <div id="dadosPrincipais" class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <!-- Será preenchido dinamicamente -->
          </div>
        </div>

        <div class="section-divider"></div>

        <!-- Sócios -->
        <div id="qsaCard" class="data-card fade-in mb-6">
          <h2 class="text-xl font-bold mb-4 text-gray-800">Quadro de Sócios (QSA)</h2>
          <div id="qsa" class="space-y-2">
            <!-- Será preenchido dinamicamente -->
          </div>
        </div>

        <div class="section-divider"></div>

        <!-- CNAEs Secundários -->
        <div id="cnaesCard" class="data-card fade-in mb-6">
          <h2 class="text-xl font-bold mb-4 text-gray-800">CNAEs Secundários</h2>
          <ul id="cnaes_secundarios" class="list-disc pl-5 space-y-1">
            <!-- Será preenchido dinamicamente -->
          </ul>
        </div>

        <div class="section-divider"></div>

        <!-- Regime Tributário -->
        <div id="regimeCard" class="data-card fade-in mb-6">
          <h2 class="text-xl font-bold mb-4 text-gray-800">Regime Tributário</h2>
          <ul id="regime_tributario" class="list-disc pl-5 space-y-1">
            <!-- Será preenchido dinamicamente -->
          </ul>
        </div>

        <div class="section-divider"></div>

        <!-- Outras Informações -->
        <div id="outrasInfoCard" class="data-card fade-in">
          <h2 class="text-xl font-bold mb-4 text-gray-800">Outras Informações</h2>
          <div id="outrasInfo" class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <!-- Será preenchido dinamicamente -->
          </div>
        </div>
      </div>
    </div>
  </main>

  <footer class="py-6 text-center text-gray-600 bg-white mt-8 border-t">
    <p>© EmpreendaCheck - Todos os direitos reservados</p>
  </footer>

  <script>
    function validarCNPJ(cnpj) {
      cnpj = cnpj.replace(/[^\d]/g, '');
      if (cnpj.length !== 14 || /^(\d)\1+$/.test(cnpj)) return false;

      let tamanho = cnpj.length - 2;
      let numeros = cnpj.substring(0, tamanho);
      let digitos = cnpj.substring(tamanho);
      let soma = 0;
      let pos = tamanho - 7;

      for (let i = tamanho; i >= 1; i--) {
        soma += numeros.charAt(tamanho - i) * pos--;
        if (pos < 2) pos = 9;
      }

      let resultado = soma % 11 < 2 ? 0 : 11 - (soma % 11);
      if (resultado !== parseInt(digitos.charAt(0))) return false;

      tamanho = tamanho + 1;
      numeros = cnpj.substring(0, tamanho);
      soma = 0;
      pos = tamanho - 7;

      for (let i = tamanho; i >= 1; i--) {
        soma += numeros.charAt(tamanho - i) * pos--;
        if (pos < 2) pos = 9;
      }

      resultado = soma % 11 < 2 ? 0 : 11 - (soma % 11);
      return resultado === parseInt(digitos.charAt(1));
    }

    document.addEventListener("DOMContentLoaded", () => {
      const input = document.getElementById("cnpjInput");
      const searchBtn = document.getElementById("searchBtn");
      const resultDiv = document.getElementById("result");
      const errorDiv = document.getElementById("error");
      const loadingOverlay = document.getElementById("loadingOverlay");
      const exportBtn = document.getElementById("exportPdfBtn");

      input.addEventListener("input", (e) => {
        let v = e.target.value.replace(/\D/g, "");
        if (v.length > 14) v = v.substring(0, 14);
        if (v.length > 12) v = v.replace(/(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})/, "$1.$2.$3/$4-$5");
        else if (v.length > 8) v = v.replace(/(\d{2})(\d{3})(\d{3})(\d{4})/, "$1.$2.$3/$4");
        else if (v.length > 5) v = v.replace(/(\d{2})(\d{3})(\d{3})/, "$1.$2.$3/");
        else if (v.length > 2) v = v.replace(/(\d{2})(\d{3})/, "$1.$2.");
        e.target.value = v;
      });

      const fetchCNPJ = async (cnpj) => {
        cnpj = cnpj.replace(/[^\d]/g, "");
        if (!validarCNPJ(cnpj)) {
          showError("CNPJ inválido. Verifique os dígitos.");
          return;
        }

        try {
          loadingOverlay.classList.remove("hidden");
          errorDiv.classList.add("hidden");
          resultDiv.classList.add("hidden");

          const response = await fetch(`https://brasilapi.com.br/api/cnpj/v1/${cnpj}`);
          const data = await response.json();

          if (data.erro) {
            showError("CNPJ não encontrado.");
            return;
          }

          fillResult(data);
          resultDiv.classList.remove("hidden");
        } catch (err) {
          console.error(err);
          showError("Erro ao buscar dados. Tente novamente.");
        } finally {
          loadingOverlay.classList.add("hidden");
        }
      };

      const showError = (msg) => {
        document.getElementById("errorMsg").textContent = msg;
        errorDiv.classList.remove("hidden");
      };

      const fillResult = (data) => {
        const dadosPrincipais = document.getElementById("dadosPrincipais");
        const qsaDiv = document.getElementById("qsa");
        const cnaesList = document.getElementById("cnaes_secundarios");
        const regimeList = document.getElementById("regime_tributario");
        const outrasInfo = document.getElementById("outrasInfo");

        // Limpar conteúdo anterior
        dadosPrincipais.innerHTML = "";
        qsaDiv.innerHTML = "";
        cnaesList.innerHTML = "";
        regimeList.innerHTML = "";
        outrasInfo.innerHTML = "";

        // Dados principais
        const camposPrincipais = [
          { label: "Razão Social", value: data.razao_social },
          { label: "Nome Fantasia", value: data.nome_fantasia },
          { label: "CNPJ", value: formatCNPJ(data.cnpj) },
          { label: "UF", value: data.uf },
          { label: "Município", value: data.municipio },
          { label: "Logradouro", value: `${data.descricao_tipo_de_logradouro || ''} ${data.logradouro || ''}`.trim() },
          { label: "Número", value: data.numero },
          { label: "Complemento", value: data.complemento },
          { label: "Bairro", value: data.bairro },
          { label: "CEP", value: data.cep },
          { label: "Telefone", value: data.ddd_telefone_1 ? `(${data.ddd_telefone_1}) ${data.telefone_1 || ''}` : null },
          { label: "Email", value: data.email },
          { label: "Situação Cadastral", value: data.descricao_situacao_cadastral },
          { label: "Data de Início de Atividade", value: data.data_inicio_atividade },
          { label: "Porte", value: data.porte },
          { label: "Natureza Jurídica", value: data.natureza_juridica },
          { label: "CNAE Fiscal", value: data.cnae_fiscal },
          { label: "CNAE Fiscal Descrição", value: data.cnae_fiscal_descricao },
        ];

        camposPrincipais.forEach(campo => {
          if (campo.value) {
            const div = document.createElement("div");
            div.classList.add("data-item");
            div.innerHTML = `<span class="font-semibold">${campo.label}:</span> <span>${campo.value}</span>`;
            dadosPrincipais.appendChild(div);
          }
        });

        // Sócios
        if (data.qsa && data.qsa.length > 0) {
          data.qsa.forEach(socio => {
            const p = document.createElement("p");
            p.classList.add("data-item");
            p.textContent = `${socio.nome_socio} - ${socio.qualificacao_socio} (${socio.faixa_etaria})`;
            qsaDiv.appendChild(p);
          });
        } else {
          document.getElementById("qsaCard").style.display = "none";
        }

        // CNAEs Secundários
        if (data.cnaes_secundarios && data.cnaes_secundarios.length > 0) {
          data.cnaes_secundarios.forEach(cnae => {
            const li = document.createElement("li");
            li.classList.add("data-item");
            li.textContent = `${cnae.codigo} - ${cnae.descricao}`;
            cnaesList.appendChild(li);
          });
        } else {
          document.getElementById("cnaesCard").style.display = "none";
        }

        // Regime Tributário
        if (data.regime_tributario && data.regime_tributario.length > 0) {
          data.regime_tributario.forEach(tributo => {
            const li = document.createElement("li");
            li.classList.add("data-item");
            li.textContent = `${tributo.ano}: ${tributo.forma_de_tributacao}`;
            regimeList.appendChild(li);
          });
        } else {
          document.getElementById("regimeCard").style.display = "none";
        }

        // Outras informações
        const outrosCampos = [
          { label: "Capital Social", value: data.capital_social ? `R$ ${data.capital_social.toLocaleString('pt-BR')}` : null },
          { label: "Situação Especial", value: data.situacao_especial },
          { label: "Data da Situação Especial", value: data.data_situacao_especial },
          { label: "Opção pelo Simples", value: data.opcao_pelo_simples !== null ? (data.opcao_pelo_simples ? "Sim" : "Não") : null },
          { label: "Data Opção Simples", value: data.data_opcao_pelo_simples },
          { label: "Data Exclusão Simples", value: data.data_exclusao_do_simples },
          { label: "Opção pelo MEI", value: data.opcao_pelo_mei !== null ? (data.opcao_pelo_mei ? "Sim" : "Não") : null },
          { label: "Data Opção MEI", value: data.data_opcao_pelo_mei },
          { label: "Data Exclusão MEI", value: data.data_exclusao_do_mei },
          { label: "Motivo da Situação Cadastral", value: data.descricao_motivo_situacao_cadastral },
          { label: "Ente Federativo Responsável", value: data.ente_federativo_responsavel },
        ];

        outrosCampos.forEach(campo => {
          if (campo.value) {
            const div = document.createElement("div");
            div.classList.add("data-item");
            div.innerHTML = `<span class="font-semibold">${campo.label}:</span> <span>${campo.value}</span>`;
            outrasInfo.appendChild(div);
          }
        });

        // Ocultar seção se não tiver nenhum campo
        if (outrasInfo.children.length === 0) {
          document.getElementById("outrasInfoCard").style.display = "none";
        } else {
          document.getElementById("outrasInfoCard").style.display = "block";
        }
      };

      const formatCNPJ = (cnpj) => {
        return cnpj.replace(/(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})/, "$1.$2.$3/$4-$5");
      };

      // Exportar PDF
      exportBtn.addEventListener("click", async () => {
        const { jsPDF } = window.jspdf;
        const element = document.getElementById("result");

        try {
          const canvas = await html2canvas(element, {
            scale: 2,
            useCORS: true,
            logging: false,
            // Oculta temporariamente cards vazios para a captura
            onclone: (clonedDoc) => {
              const emptyCards = clonedDoc.querySelectorAll('.data-card[style*="display: none"]');
              emptyCards.forEach(card => card.style.display = 'none');
            }
          });
          const imgData = canvas.toDataURL('image/png');
          const pdf = new jsPDF('p', 'mm', 'a4');
          const imgWidth = 190;
          const pageHeight = 295;
          const imgHeight = (canvas.height * imgWidth) / canvas.width;
          let heightLeft = imgHeight;
          let position = 10;

          pdf.addImage(imgData, 'PNG', 10, position, imgWidth, imgHeight);
          heightLeft -= pageHeight;

          while (heightLeft >= 0) {
            position = heightLeft - imgHeight;
            pdf.addPage();
            pdf.addImage(imgData, 'PNG', 10, position, imgWidth, imgHeight);
            heightLeft -= pageHeight;
          }

          pdf.save(`dados_empresa_${document.getElementById("cnpj").textContent || "cnpj"}.pdf`);
        } catch (error) {
          console.error("Erro ao gerar PDF:", error);
          alert("Erro ao exportar PDF. Tente novamente.");
        }
      });

      searchBtn.addEventListener("click", () => {
        fetchCNPJ(input.value);
      });

      input.addEventListener("keypress", (e) => {
        if (e.key === "Enter") fetchCNPJ(input.value);
      });
    });
  </script>
</body>
</html>
